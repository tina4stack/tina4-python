<div id="crudTarget{{ table_name }}">
    <script>
        formToken = `{{ formToken({"token": RANDOM()}) }}`;
    </script>
    <div class="container-fluid">
        <h1>{{ table_name }}</h1>
        <div class="row mb-4 align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           id="search{{ table_name }}"
                           placeholder="Search..."
                           value="{{ options.search|default('') }}"
                           autocomplete="off">
                    <button class="btn btn-outline-primary" type="button" id="btnSearch{{ table_name }}">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>
            <div class="col-md-3 text-end">
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination{{ table_name }}"></ul>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#crudModal{{ table_name }}"
                        onclick="addRecord{{ table_name }}()">
                    <i class="bi bi-plus-lg"></i> Create
                </button>
            </div>
        </div>
        {# Main content - table or card view #}
        {% if options.card_view|default(false) %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for record in records %}
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">
                                    {{ record[options.title_field|default(columns[0].name)]|default('Record') }}
                                </h5>
                                <div class="card-text">
                                    {% for column in columns %}
                                        {% set name = column.name %}
                                        {% set value = (record[name] | default('')) | string %}

                                        {# --- Detect image by magic bytes (no ternary, no starts with) --- #}
                                        {% set is_image = False %}
                                        {% set check_value = value | detect_image   %}

                                        {% if check_value.content_type  %}
                                            {% set is_image = True %}
                                            {% set value = check_value.content %}
                                            {% set mime_type = check_value.mime_type %}
                                        {% endif %}

                                        {# --- Only show image if it's base64-like and long enough --- #}
                                        {% if is_image and value|length > 50 and value is string %}
                                            {% set src = value %}
                                            {% if value[:10] != 'data:image/' %}
                                                {% set src = 'data:image/' ~ mime_type ~ ';base64,' ~ value %}
                                            {% endif %}

                                            <div class="mb-3">
                                                <strong>{{ column.label|default(column.name|replace('_', ' ')|title) }}
                                                    :</strong><br>
                                                <img src="{{ src }}"
                                                     alt="Image"
                                                     class="img-thumbnail mt-2"
                                                     style="max-height: 200px; max-width: 100%; border-radius: 8px; object-fit: cover;">
                                            </div>
                                        {% else %}
                                            <div class="mb-2">
                                                <strong>{{ column.label|default(column.name|replace('_', ' ')|title) }}
                                                    :</strong>
                                                <span class="text-muted">{{ value }}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                        data-bs-toggle="modal" data-bs-target="#crudModal{{ table_name }}"
                                        onclick='loadRecord{{ table_name }}({{ record|json_encode }}, {{ loop.index0 }})'>
                                    Update
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick='confirmDelete{{ table_name }}({{ record.id|default(loop.index0) }})'>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">No records found</p>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-light">
                <tr>
                    {% for column in columns %}
                        <th scope="col">{{ column.label|default(column.name|nice_label) }}</th>
                    {% endfor %}
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for record in records %}
                    <tr>
                        {% for column in columns %}
                            {% set name = column.name %}
                            {% set value = record[name]|e %}

                            {% set is_image = False %}

                            {% set check_value = value | detect_image   %}

                            {% if check_value.content_type  %}
                                {% set is_image = True %}
                                {% set value = check_value.content %}
                                {% set mime_type = check_value.mime_type %}
                            {% endif %}
                            <td>
                                {# --- Only show image if it's base64-like and long enough --- #}
                                {% if is_image  %}
                                    {% set src = value %}
                                    {% if value[:10] != 'data:image/' %}
                                        {% set src = 'data:image/' ~ mime_type ~ ';base64,' ~ value %}
                                    {% endif %}

                                    <img src="{{ src }}"
                                         alt="Image"
                                         class="img-thumbnail mt-2"
                                         style="max-height: 200px; max-width: 100%; border-radius: 8px; object-fit: cover;">
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                    data-bs-toggle="modal" data-bs-target="#crudModal{{ table_name }}"
                                    onclick='loadRecord{{ table_name }}({{ record|json_encode }}, {{ loop.index0 }})'>
                                Update
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick='confirmDelete{{ table_name }}({{ record.id|default(loop.index0) }})'>
                                Delete
                            </button>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="{{ columns|length + 1 }}" class="text-center text-muted py-4">
                            No records found
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    {# Bootstrap Modal #}
    <div class="modal fade" id="crudModal{{ table_name }}" tabindex="-1" aria-labelledby="crudModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crudModalLabel{{ table_name }}">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="crudForm{{ table_name }}" method="POST" onsubmit="return false">
                    <div class="modal-body" id="modalBody{{ table_name }}">
                        <!-- Form fields loaded dynamically by JS -->
                    </div>
                    {{ (table_name~RANDOM()) | formToken }}
                    <div class="modal-footer">
                        <button id="saveButton{{ table_name }}" type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function loadRecord{{ table_name }}(record, index) {
            const modalBody = document.getElementById('modalBody{{ table_name }}');
            const saveButton = document.getElementById('saveButton{{ table_name }}');
            const formLabel = document.getElementById('crudModalLabel{{ table_name }}');

            formLabel.innerText = `Update Record`;
            let html = '';
            let field = null;
            let label = null;
            let value = null;
            let type = null;
            let isImage = false;
            let mimeType = 'jpeg';
            let rawValue = null;
            {% for column in columns %}
            field = "{{ column.name }}";
            label = "{{ column.label|default(column.name|nice_label) }}";
            value = record[field] || '';
            try {
                rawValue = JSON.parse(record[field] || '');
            } catch (e) {
                rawValue = record[field];
            }
            type = "{{ column.type|default('text') }}";

            if (typeof rawValue === 'object' && rawValue !== null) {
                if (rawValue.content) {
                    value = rawValue.content;
                    if (rawValue.content_type && rawValue.content_type.startsWith('image/')) {
                        mimeType = rawValue.content_type.split('/')[1];  // png, jpeg, webp, etc.
                        isImage = true;
                    }
                }
            }

            if (value && typeof value === 'string') {
                if (value.startsWith('data:image/')) {
                    isImage = true;
                } else if (value.substring(0, 4) === '/9j/') {
                    isImage = true;
                    mimeType = 'jpeg';
                } else if (value.substring(0, 11) === 'iVBORw0KGgo') {
                    isImage = true;
                    mimeType = 'png';
                } else if (value.substring(0, 6) === 'R0lGOD') {
                    isImage = true;
                    mimeType = 'gif';
                } else if (value.substring(0, 5) === 'UklGR') {
                    isImage = true;
                    mimeType = 'webp';
                }
            }

            // --- If it's an image → show preview + file upload ---
            if (isImage && value.length > 50 || field.indexOf('image') !== -1) {
                let imageSrc = value;
                if (value.length > 0 && !value.startsWith('data:image/')) {
                    imageSrc = `data:image/${mimeType};base64,${value}`;
                }

                html += `
    <div class="mb-3">
        <label class="form-label fw-bold">${label}</label>
        <div class="border rounded p-3 bg-light text-center">
            <img src="${imageSrc}"
                 alt="Current ${label}"
                 class="img-thumbnail mb-3"
                 style="max-height: 180px; max-width: 100%;">
            <div>
                <input type="file"
                       accept="image/*"
                       class="form-control form-control-sm"
                       id="${field}"
                       name="${field}">
                <small class="text-muted">Choose new image (optional)</small>
            </div>
        </div>
    </div>`;
            } else {
                // Normal text/password input
                html += `
    <div class="mb-3">
        <label for="${field}" class="form-label">${label}</label>
        <input type="${type === 'password' ? 'password' : 'text'}"
               class="form-control"
               id="${field}"
               name="${field}"
               placeholder="${label}"
               value="${value}">
    </div>`;
            }
            {% endfor %}

            modalBody.innerHTML = html;

            // Inside loadRecord{{ table_name }}
            saveButton.onclick = () => {
                postForm('crudForm{{ table_name }}', window.location.pathname + "/{{ table_name }}/" + (record.id || index), null, function () {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('crudModal{{ table_name }}'));
                    modal.hide();

                    window['reloadPage{{ table_name }}']();
                });
            };

        }

        function addRecord{{ table_name }}() {
            const modalBody = document.getElementById('modalBody{{ table_name }}');
            const saveButton = document.getElementById('saveButton{{ table_name }}');

            const formLabel = document.getElementById('crudModalLabel{{ table_name }}');

            formLabel.innerText = `Create Record`;

            let html = '';
            let field = null;
            let label = null;
            let value = null;
            let type = null;
            {% for column in columns %}
            field = `{{ column.name }}`;
            label = `{{ column.label|default(column.name|nice_label) }}`;
            value = '';
            type = `{{ column.type|default('text') }}`;

            html += `<div class="mb-3">
                    <label for="${field}" class="form-label">${label}</label>
                    <input type="${type === 'password' ? 'password' : 'text'}"
                           class="form-control"
                           id="${field}"
                           name="${field}"
                           placeholder="${label}"
                           value='${value}'>
                </div>`;
            {% endfor %}

            modalBody.innerHTML = html;

            // Inside loadRecord{{ table_name }}
            saveButton.onclick = () => {
                postForm('crudForm{{ table_name }}', window.location.pathname + "/{{ table_name }}", null, function () {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('crudModal{{ table_name }}'));
                    modal.hide();

                    window['reloadPage{{ table_name }}']();
                });
            };

        }


        function confirmDelete{{ table_name }}(id) {
            console.log("formToken", formToken);
            if (confirm("Are you sure you want to delete this record?")) {
                sendRequest(window.location.pathname + "/{{ table_name }}/" + id, null, "DELETE",
                    function (response) {
                        window['reloadPage{{ table_name }}']();
                    })
            }
        }


        window['config_crud_{{ table_name }}'] = {
            perPage: {{ options.limit }},
            total: {{ total_records |default(records|length) }}
        };

        (function () {
            const tableKey = "crud_{{ table_name }}";
            const inputId  = "search{{ table_name }}";
            const btnId    = "btnSearch{{ table_name }}";
            const clearId  = "btnClear{{ table_name }}";

            function initSearch() {
                const input = document.getElementById(inputId);
                const btn   = document.getElementById(btnId);
                const clear = document.getElementById(clearId);

                if (!input) return;

                // Remove any old listeners
                input.onkeydown = null;
                input.oninput   = null;
                if (btn) btn.onclick = null;
                if (clear) clear.onclick = null;

                // Enter key → search
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        triggerSearch();
                    }
                });

                // Search button
                if (btn) {
                    btn.addEventListener('click', triggerSearch);
                }

                // Clear button
                if (clear) {
                    clear.addEventListener('click', () => {
                        input.value = '';
                        triggerSearch();
                    });
                }

                // Live search (debounced)
                input.addEventListener('input', () => {
                    clearTimeout(window.searchTimeout_{{ table_name }});
                    window.searchTimeout_{{ table_name }} = setTimeout(triggerSearch, 400);
                });

                // Focus + cursor to end if there's already text
                focusSearchInputIfNeeded();
            }

            function triggerSearch() {
                window['goToPage_{{ table_name }}'](1);
            }

            function focusSearchInputIfNeeded() {
                const input = document.getElementById(inputId);
                if (!input) return;
                if (input.value.trim().length > 0) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }

            // Pagination navigation
            window['goToPage_{{ table_name }}'] = function (page = 1) {
                const input = document.getElementById(inputId);
                const search = (input?.value || '').trim();
                const limit = {{ options.limit|default(10) }};
                const offset = (page - 1) * limit;

                const url = new URL(location.pathname + "/{{ table_name }}", location.origin);
                url.searchParams.set('limit', limit);
                url.searchParams.set('offset', offset);
                if (search) url.searchParams.set('search', search);

                loadPage(url.toString(), "crudTarget{{ table_name }}", () => {
                    renderPagination(page);
                });
            };

            function renderPagination(currentPage) {
                const config = window['config_crud_{{ table_name }}'] || {
                    total: {{ total_records|default(0) }},
                    perPage: {{ options.limit|default(10) }}
                };
                const totalPages = config.total > 0 ? Math.ceil(config.total / config.perPage) : 1;
                const container = document.getElementById('pagination{{ table_name }}');
                if (!container) return;

                container.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = 'page-item' + (i === currentPage ? ' active' : '');
                    li.innerHTML = `<a class="page-link" href="#" onclick="window['goToPage_{{ table_name }}'](${i}); return false;">${i}</a>`;
                    container.appendChild(li);
                }
            }
            window['renderPagination_{{ table_name }}'] = renderPagination;

            // Reload current page after create/update/delete
            window['reloadPage{{ table_name }}'] = function () {
                const p = new URLSearchParams(location.search);
                const o = parseInt(p.get('offset') || 0);
                const l = {{ options.limit|default(10) }};
                const pg = Math.max(1, Math.floor(o / l) + 1);
                window['goToPage_{{ table_name }}'](pg);
            };

            // Re-attach search after every AJAX reload
            if (!window.loadPagePatched_{{ table_name }}) {
                const originalLoadPage = window.loadPage;
                window.loadPage = function (url, target, cb) {
                    originalLoadPage(url, target, () => {
                        setTimeout(() => {
                            initSearch();
                            focusSearchInputIfNeeded();
                        }, 50);
                        if (cb) cb();
                    });
                };
                window.loadPagePatched_{{ table_name }} = true;
            }

            // Initial load
            initSearch();
            focusSearchInputIfNeeded();

            // Initial pagination render
            const params = new URLSearchParams(location.search);
            const offset = parseInt(params.get('offset') || 0);
            const limit = {{ options.limit|default(10) }};
            const page = Math.max(1, Math.floor(offset / limit) + 1);
            renderPagination(page);

        })();
    </script>
</div>
{# <div id="message"></div> #}
{# You only need the bootstrap libraries and tina4helper below if you don't include them anywhere else #}
{# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"> #}
{# <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> #}
{# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11/font/bootstrap-icons.css">  #}
{# <script src="/js/tina4helper.js"></script> #}
