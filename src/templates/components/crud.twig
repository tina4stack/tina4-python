<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<script>
    formToken = `{{ formToken() }}`;
</script
<div class="container-fluid">
    <h1>{{ table_name }}</h1>

    {# Main content - table or card view #}
    {% if options.card_view|default(false) %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for record in records %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">
                                {{ record[options.title_field|default(columns[0].name)]|default('Record') }}
                            </h5>
                            <div class="card-text">
                                {% for column in columns %}
                                    {% set name = column.name %}
                                    <div class="mb-2">
                                        <strong>{{ column.label|default(column.name|nice_label) }}:</strong>
                                        <span class="text-muted">{{ record[name]|e }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    data-bs-toggle="modal" data-bs-target="#crudModal"
                                    onclick="loadRecord({{ record|json_encode }}, {{ loop.index0 }})">
                                Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="confirmDelete({{ record.id|default(loop.index0) }})">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12 text-center py-5">
                    <p class="text-muted">No records found</p>
                </div>
            {% endfor %}
        </div>

    {% else %}
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-light">
            <tr>
                {% for column in columns %}
                    <th scope="col">{{ column.label|default(column.name|nice_label) }}</th>
                {% endfor %}
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for record in records %}
                <tr>
                    {% for column in columns %}
                        {% set name = column.name %}
                        <td>{{ record[name]|e }}</td>
                    {% endfor %}
                    <td class="text-nowrap">
                        <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                data-bs-toggle="modal" data-bs-target="#crudModal"
                                onclick='loadRecord({{ record|json_encode }}, {{ loop.index0 }})'>
                            Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick='confirmDelete({{ record.id|default(loop.index0) }})''>
                        Delete
                        </button>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="{{ columns|length + 1 }}" class="text-center text-muted py-4">
                        No records found
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

{# Bootstrap Modal #}
<div class="modal fade" id="crudModal" tabindex="-1" aria-labelledby="crudModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crudModalLabel">Edit Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="crudForm{{ table_name }}" method="POST" onsubmit="return false">
                <div class="modal-body" id="modalBody">
                    <!-- Form fields loaded dynamically by JS -->
                </div>
                {{  (table_name~RANDOM()) | formToken }}
                <div class="modal-footer">
                    <button id="saveButton{{ table_name }}" type="submit" class="btn btn-primary" >Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadRecord(record, index) {
        const modalBody = document.getElementById('modalBody');
        const saveButton = document.getElementById('saveButton{{ table_name }}');

        let html = '';
        let field = null;
        let label = null;
        let value = null;
        let type = null;
        {% for column in columns %}
        field = `{{ column.name }}`;
        label = `{{ column.label|default(column.name|nice_label) }}`;
        value = record[field] || '';
        type = `{{ column.type|default('text') }}`;

        html += `<div class="mb-3">
                    <label for="${field}" class="form-label">${label}</label>
                    <input type="${type === 'password' ? 'password' : 'text'}"
                           class="form-control"
                           id="${field}"
                           name="${field}"
                           value='${value}'>
                </div>`;
        {% endfor %}

        modalBody.innerHTML = html;

        saveButton.onclick = () => {
            postForm('crudForm{{ table_name }}', window.location.pathname + "/{{ table_name }}/" + (record.id || index));
        };
    }

    function confirmDelete(id) {
        console.log("formToken", formToken);
        if (confirm("Are you sure you want to delete this record?")) {
            sendRequest(window.location.pathname + "/{{ table_name }}/"+id, null, "DELETE",
                function (response) {
                    console.log(response);
                })
        }
    }
</script>